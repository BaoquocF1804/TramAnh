<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="theme-color" content="#0f1115">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <title>Bao Quoc</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&family=Space+Mono:wght@400;700&display=swap" rel="stylesheet">
  <style>
    :root{
      --bg: #0f1115;
      --fg: #e8eaed;
      --muted: #b6bdc6;
      --shade1: #8b9096;
      --shade2: #a3a8ae;
      --shade3: #c1c7ce;
      --shade4: #e1e6ea;
      --accent: #b3ff00;
    }
    html,body{height:100%}
    body{
      margin:0;
      font-family: "Space Mono", ui-monospace, SFMono-Regular, Menlo, Consolas, monospace;
      background: radial-gradient(1200px 700px at 30% 10%, rgba(255,255,255,0.04), transparent 60%), var(--bg);
      color: var(--fg);
      text-rendering: optimizeLegibility;
      -webkit-font-smoothing: antialiased;
      overflow-x: hidden;
      min-height: 100vh;
      min-height: 100dvh;
      touch-action: manipulation;
    }
    body::after{
      content:"";
      position:fixed; inset:0; pointer-events:none;
      background:repeating-linear-gradient(to bottom, rgba(255,255,255,0.04), rgba(255,255,255,0.04) 1px, transparent 2px, transparent 3px);
      mix-blend-mode:soft-light; opacity:.25;
    }

    .app { position: relative; width: 100%; height: 100%; }

    .container {
      position: relative;
      width: 100%;
      min-height: 100vh;
      min-height: 100dvh;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      box-sizing: border-box;
      padding: 20px;
    }

    canvas {
      position: absolute;
      width: 100%;
      height: 100%;
      display: block;
      cursor: pointer;
      z-index: 1;
      top: 0;
      left: 0;
    }

    .heart-text {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      z-index: 2;
      text-align: center;
      color: #fff;
      text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
      pointer-events: none;
      max-width: 90vw;
      word-break: break-word;
    }
    .heart-text h1 {
      font-family: "Press Start 2P", monospace;
      font-size: clamp(2rem, 8vw, 3.5rem);
      margin: 0;
      font-weight: bold;
      background: linear-gradient(45deg, #1a191a, #bdb9bb);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      animation: pulse 2s ease-in-out infinite;
      line-height: 1.2;
    }
    .heart-text h1#daysCount {
      font-family: "Press Start 2P", monospace;
      font-size: clamp(2rem, 8vw, 3.5rem);
      margin: 0;
      font-weight: bold;
      background: linear-gradient(45deg, #ea80b0, #fff);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      text-shadow: 2px 2px 8px #ea80b044, 0 0 12px #fff6;
      animation: pulse 2s ease-in-out infinite;
      line-height: 1.2;
    }
    .heart-text p { 
      font-size: clamp(1rem, 3vw, 1.2rem); 
      margin: 10px 0 0 0; 
      opacity: 0.9; 
      line-height: 1.4;
    }

    .buttons-container {
      position: absolute;
      bottom: clamp(40px, 7vh, 80px);
      left: 50%;
      transform: translateX(-50%);
      z-index: 2;
      display: flex;
      gap: clamp(8px, 2vw, 12px);
      flex-wrap: wrap;
      justify-content: center;
      max-width: 90vw;
    }
    .btn{
      border: 1px solid rgba(255,255,255,.12);
      padding: clamp(10px, 2.5vw, 12px) clamp(12px, 3vw, 16px); 
      border-radius: 12px; 
      font-weight: 700; 
      letter-spacing: .04em;
      background: rgba(255,255,255,.02); color: var(--fg);
      text-decoration: none; 
      display: inline-flex; 
      gap: .6ch; 
      align-items: center;
      transition: transform .08s ease, background .2s ease, border-color .2s ease;
      cursor: pointer;
      font-size: clamp(11px, 2.2vw, 14px);
      min-height: 44px;
      justify-content: center;
      text-align: center;
      white-space: nowrap;
    }
    .btn:hover, .btn:focus{ 
      background: rgba(255,255,255,.05); 
      border-color: rgba(255,255,255,.24); 
      transform: translateY(-1px); 
      outline: none;
    }
    .btn:active{ transform: translateY(0); }
    .btn.primary{ background: linear-gradient(180deg, rgba(179,255,0,.16), rgba(179,255,0,.08)); border-color: rgba(179,255,0,.35); }

    @keyframes pulse { 0%,100%{transform:scale(1);} 50%{transform:scale(1.05);} }

    /* ===== Terminal (·∫©n m·∫∑c ƒë·ªãnh, tr∆∞·ª£t v√†o khi m·ªü) ===== */
    .terminal {
      position: fixed;
      left: clamp(12px, 3vw, 24px); 
      top: clamp(12px, 3vw, 24px); 
      bottom: clamp(12px, 3vw, 24px);
      width: min(420px, calc(100vw - 48px));
      max-width: calc(100vw - 24px);
      z-index: 5;
      display: flex; flex-direction: column;
      border-radius: 16px;
      border: 1px solid rgba(255,255,255,0.12);
      background: linear-gradient(180deg, rgba(20,22,28,0.92), rgba(16,18,23,0.92));
      backdrop-filter: blur(8px);
      box-shadow: 0 10px 30px rgba(0,0,0,0.45), inset 0 1px 0 rgba(255,255,255,0.06);
      overflow: hidden;

      transform: translateX(-120%);
      opacity: 0;
      pointer-events: none;
      transition: transform .35s ease, opacity .35s ease;
    }
    .terminal.open {
      transform: translateX(0);
      opacity: 1;
      pointer-events: auto;
    }
    .terminal__topbar {
      display: flex; align-items: center; gap: 8px;
      padding: clamp(8px, 2vw, 10px) clamp(10px, 2.5vw, 12px);
      border-bottom: 1px solid rgba(255,255,255,0.08);
      background: linear-gradient(180deg, rgba(255,255,255,0.05), rgba(255,255,255,0.02));
      user-select: none;
      flex-shrink: 0;
    }
    .traffic { display: flex; gap: 8px; }
    .dot { 
      width: clamp(10px, 2.5vw, 12px); 
      height: clamp(10px, 2.5vw, 12px); 
      border-radius: 50%; 
      box-shadow: inset 0 1px 2px rgba(0,0,0,0.35); 
    }
    .dot.red{background:#ff5f56;border:1px solid #e0443e}
    .dot.yellow{background:#ffbd2e;border:1px solid #dea123}
    .dot.green{background:#27c93f;border:1px solid #1ea836}
    .terminal__title { 
      margin-left: 6px; 
      font-size: clamp(10px, 2vw, 12px); 
      color: var(--shade3); 
      letter-spacing: .02em; 
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .terminal__spacer { flex: 1; }
    .terminal__close {
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.05);
      color: var(--shade4);
      font-size: clamp(10px, 2vw, 12px);
      border-radius: 8px;
      padding: clamp(3px, 1vw, 4px) clamp(6px, 1.5vw, 8px);
      cursor: pointer;
      min-width: 24px;
      min-height: 24px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .terminal__body {
      flex: 1; 
      padding: clamp(12px, 3vw, 14px) clamp(14px, 3.5vw, 16px) clamp(16px, 4vw, 18px) clamp(14px, 3.5vw, 16px); 
      overflow: auto;
      line-height: 1.55; 
      font-size: clamp(11px, 2.5vw, 13px); 
      color: var(--shade4);
      scrollbar-width: thin;
    }
    .terminal__body::-webkit-scrollbar { width: 8px; }
    .terminal__body::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.12); border-radius: 8px; }

    .line { white-space: pre-wrap; word-break: break-word; }
    .prompt { color: var(--accent); }
    .path { color: #bdb9bb; }
    .caret { 
      display: inline-block; 
      width: clamp(6px, 1.5vw, 8px); 
      height: 1.1em; 
      vertical-align: -0.15em; 
      background: var(--fg); 
      margin-left: 3px; 
      animation: blink 1.2s steps(1) infinite; 
    }
    @keyframes blink { 0%,49%{opacity:1} 50%,100%{opacity:0} }

    /* Backdrop m·ªù ph√≠a sau terminal */
    .backdrop {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.35);
      z-index: 4;
      opacity: 0;
      pointer-events: none;
      transition: opacity .35s ease;
    }
    .backdrop.open {
      opacity: 1;
      pointer-events: auto;
    }

    /* Mobile optimizations */
    @media (max-width: 768px) { 
      .terminal{
        left: 12px;
        right: 12px;
        top: 12px;
        bottom: 12px;
        width: auto;
        max-width: none;
      }
      .buttons-container{
        flex-direction: column;
        align-items: center;
        gap: 8px;
      }
      .btn{
        min-width: 200px;
        max-width: 280px;
      }
      .heart-text h1, .heart-text h1#daysCount{
        font-size: clamp(1.5rem, 6vw, 2.5rem);
      }
    }

    @media (max-width: 480px) {
      .container{
        padding: 12px;
      }
      .terminal{
        left: 8px;
        right: 8px;
        top: 8px;
        bottom: 8px;
      }
      .buttons-container{
        bottom: 30px;
      }
      .btn{
        font-size: 12px;
        padding: 8px 12px;
        min-width: 180px;
      }
    }

    /* Landscape mobile */
    @media (max-height: 500px) and (orientation: landscape){
      .heart-text h1, .heart-text h1#daysCount{
        font-size: clamp(1.2rem, 5vw, 2rem);
      }
      .buttons-container{
        bottom: 20px;
        flex-direction: row;
        gap: 8px;
      }
      .btn{
        font-size: 11px;
        padding: 6px 10px;
        min-width: auto;
      }
      .terminal{
        width: min(350px, calc(100vw - 24px));
      }
    }

    /* High DPI displays */
    @media (-webkit-min-device-pixel-ratio: 2), (min-resolution: 192dpi){
      body::after{
        opacity: .15;
      }
    }

    /* ===== Bucket List Panel ===== */
    .bucket{
      position: fixed;
      right: clamp(12px, 3vw, 24px);
      top: clamp(12px, 3vw, 24px);
      bottom: clamp(12px, 3vw, 24px);
      width: min(460px, calc(100vw - 48px));
      max-width: calc(100vw - 24px);
      z-index: 5;
      display: flex; flex-direction: column;
      border-radius: 16px;
      border: 1px solid rgba(255,255,255,0.12);
      background: linear-gradient(180deg, rgba(20,22,28,0.92), rgba(16,18,23,0.92));
      backdrop-filter: blur(8px);
      box-shadow: 0 10px 30px rgba(0,0,0,0.45), inset 0 1px 0 rgba(255,255,255,0.06);
      overflow: hidden;

      transform: translateX(120%);
      opacity: 0;
      pointer-events: none;
      transition: transform .35s ease, opacity .35s ease;
    }
    .bucket.open{ transform: translateX(0); opacity: 1; pointer-events: auto; }

    .bucket__topbar{
      display: flex; align-items: center; gap: 8px;
      padding: clamp(8px, 2vw, 10px) clamp(10px, 2.5vw, 12px);
      border-bottom: 1px solid rgba(255,255,255,0.08);
      background: linear-gradient(180deg, rgba(255,255,255,0.05), rgba(255,255,255,0.02));
      user-select: none;
      flex-shrink: 0;
    }
    .bucket__title{ font-size: clamp(12px, 2.2vw, 14px); color: var(--shade3); letter-spacing: .02em; }
    .bucket__spacer{ flex: 1; }
    .bucket__close{
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.05);
      color: var(--shade4);
      font-size: clamp(10px, 2vw, 12px);
      border-radius: 8px;
      padding: clamp(3px, 1vw, 4px) clamp(6px, 1.5vw, 8px);
      min-width: 24px; min-height: 24px; cursor: pointer;
    }

    .bucket__body{ 
      flex: 1; overflow: auto; 
      padding: clamp(12px, 3vw, 16px); 
      color: var(--shade4); 
      font-size: clamp(12px, 2.4vw, 14px);
    }

    /* Progress */
    .progress{ margin-bottom: 12px; }
    .progress__label{ color: var(--shade3); margin-bottom: 8px; font-size: 12px; }
    .progress__bar{ width: 100%; height: 10px; background: rgba(255,255,255,.08); border-radius: 999px; overflow: hidden; }
    .progress__bar > #blBar{ height: 100%; width: 0%; background: linear-gradient(90deg, var(--accent), #8bff80); }

    /* Form */
    .bl-form{ display: grid; grid-template-columns: 1fr max-content max-content; gap: 8px; align-items: center; margin-bottom: 12px; }
    .bl-form input{
      background: rgba(255,255,255,.04);
      border: 1px solid rgba(255,255,255,.12);
      color: var(--fg);
      border-radius: 10px;
      padding: 10px 12px;
      outline: none;
    }
    .bl-form input:focus{ border-color: rgba(255,255,255,.28); }

    /* Filters */
    .bl-filters{ display: flex; gap: 8px; margin-bottom: 8px; flex-wrap: wrap; }

    /* List */
    .bl-list{ list-style: none; margin: 0; padding: 0; display: grid; gap: 8px; }
    .bl-item{
      display: grid; grid-template-columns: 28px 1fr max-content; gap: 8px; align-items: center;
      padding: 10px; border: 1px solid rgba(255,255,255,.10); border-radius: 12px;
      background: rgba(255,255,255,.03);
    }
    .bl-item__check{
      width: 20px; height: 20px; cursor: pointer;
      accent-color: var(--accent);
    }
    .bl-item__title{ line-height: 1.35; }
    .bl-item__meta{ font-size: 12px; color: var(--shade2); margin-top: 2px; }
    .bl-item.done .bl-item__title{ text-decoration: line-through; opacity: .7; }
    .bl-item__del{
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.05);
      color: var(--shade4);
      font-size: 12px; border-radius: 8px; padding: 6px 8px; cursor: pointer;
    }

    /* Mobile tweak: panel full width */
    @media (max-width: 768px){
      .bucket{ left: 12px; right: 12px; width: auto; }
      .bl-form{ grid-template-columns: 1fr 1fr max-content; }
    }
  </style>
</head>
<body>
  <div class="app">
    <!-- Backdrop m·ªù khi m·ªü terminal/bucket -->
    <div class="backdrop" id="backdrop" tabindex="-1"></div>

    <!-- Terminal (·∫©n m·∫∑c ƒë·ªãnh) -->
    <aside class="terminal" id="terminal" aria-label="macOS-styled Terminal" aria-hidden="true">
      <div class="terminal__topbar">
        <div class="traffic" aria-hidden="true">
          <span class="dot red"></span>
          <span class="dot yellow"></span>
          <span class="dot green"></span>
        </div>
        <div class="terminal__title">baoquoc@homthuso1</div>
        <div class="terminal__spacer"></div>
        <button class="terminal__close" id="closeTerminal" title="ƒê√≥ng (Esc)">√ó</button>
      </div>
      <div class="terminal__body" id="terminalBody">
        <div class="line" style="display:none"> <span class="prompt">baoquoc@homthuso1</span>:<span class="path">~/</span>$ G·ª≠i Tr√¢m Anh</div>
        <div class="line" style="display:none">Ng√†y 0h22 ng√†y 22 - 08 - 2025!</div>
        <div class="line" style="display:none">H√¨ anh c≈©ng ƒë·∫∑t m√¨nh l√™n gi∆∞·ªùng v√† vi·∫øt ra nh·ªØng l·ªùi n√†y. N√≥i sao nh·ªâ? Hi·ªán t·∫°i ƒë·∫ßu √≥c anh kh√° tr·ªëng r·ªóng, kh√¥ng c√≥ vi·ªác g√¨ ngo√†i nghƒ© v·ªÅ em ·ªü kho·∫£nh kh·∫Øc n√†y. Anh bi·∫øt anh kh√¥ng gi·ªèi ƒÉn n√≥i, anh c≈©ng kh√¥ng bi·∫øt th·ªÉ hi·ªán c·∫£m x√∫c m√¨nh ra sao l√† ƒë√∫ng.  N√≥i v·ªÅ ng√†y h√¥m nay ƒëi, c√≥ l·∫Ω anh ph·∫£i th√∫ nh·∫≠n l√∫c ƒë∆∞a em m√≥n qu√† ƒë√≥ anh th·ª±c s·ª± kh√¥ng bi·∫øt n√≥i g√¨ kh√¥ng bi·∫øt ph·∫£i l√†m g√¨ ti·∫øp theo. C√≥ l·∫Ω ƒë√£ r·∫•t l√¢u r·ªìi anh m·ªõi t·∫∑ng ai m·ªôt m√≥n qu√† n√†o ƒë√≥ anh ƒë√£ chu·∫©n b·ªã m·ªçi th·ª© tr∆∞·ªõc khi g·∫∑p em, anh r·∫•t run anh c≈©ng nghƒ© ra nhi·ªÅu c√¢u n√≥i ƒë·ªÉ t·∫∑ng ra sao nh∆∞ng cu·ªëi c√πng anh ch·ªâ n√≥i ƒë∆∞·ª£c " anh t·∫∑ng em n√® ". Anh xin l·ªói em v√¨ ƒë√£ l√¢u nh∆∞ th·∫ø m·ªõi t·∫∑ng em 1 m√≥n qu√†.</div>
        <div class="line" style="display:none"><span class="prompt">baoquoc@homthuso1</span>:<span class="path">~/</span>$ Tr·∫°ng th√°i hi·ªán t·∫°i ...</div>
        <div class="line" style="display:none">ƒêang y√™u r·∫•t nhi·ªÅu‚Ä¶ ‚úÖ</div>
        <div class="line" style="display:none"><span class="prompt">baoquoc@homthuso1</span>:<span class="path">~/</span>$ <span class="caret" aria-hidden="true"></span></div>
      </div>
    </aside>

    <!-- Bucket List Panel (·∫©n m·∫∑c ƒë·ªãnh, tr∆∞·ª£t t·ª´ b√™n ph·∫£i) -->
    <aside class="bucket" id="bucketPanel" aria-label="Bucket List" aria-hidden="true">
      <div class="bucket__topbar">
        <div class="bucket__title">üéØ Bucket List</div>
        <div class="bucket__spacer"></div>
        <button class="bucket__close" id="closeBucket" title="ƒê√≥ng (Esc)">√ó</button>
      </div>

      <div class="bucket__body">
        <!-- Progress -->
        <div class="progress">
          <div class="progress__label"><span id="blDone">0</span>/<span id="blTotal">0</span> ho√†n th√†nh</div>
          <div class="progress__bar"><div id="blBar"></div></div>
        </div>

        <!-- Form th√™m m·ª•c -->
        <form class="bl-form" id="blForm">
          <input id="blTitle" type="text" placeholder="Vi·ªác mu·ªën l√†m (vd: Leo Fansipan)" required />
          <input id="blWhen" type="date" />
          <button class="btn primary" type="submit">Th√™m</button>
        </form>

        <!-- B·ªô l·ªçc ƒë∆°n gi·∫£n -->
        <div class="bl-filters">
          <button type="button" class="btn" data-filter="all">T·∫•t c·∫£</button>
          <button type="button" class="btn" data-filter="todo">Ch∆∞a l√†m</button>
          <button type="button" class="btn" data-filter="done">Ho√†n th√†nh</button>
        </div>

        <!-- Danh s√°ch -->
        <ul class="bl-list" id="blList" aria-live="polite"></ul>
      </div>
    </aside>

    <div class="container">
      <canvas id="pinkboard"></canvas>
      <div class="heart-text">
        <h1 id="daysCount">----</h1>
        <div id="surpriseText" style="display:none; font-size:1.7rem; font-family:'Press Start 2P', monospace; margin-top:18px; line-height:1.3; background: linear-gradient(45deg, #ea80b0, #fff); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; text-shadow: 2px 2px 8px #ea80b044, 0 0 12px #fff6; text-align:center;">
          <div class="surprise-line" style="display:none;">TRAM ANH</div>
          <div class="surprise-line" style="display:none;"><span style="font-size:2.7rem; display:inline-block; margin:12px 0;">‚ô•Ô∏è</span></div>
          <div class="surprise-line" style="display:none;">BAO QUOC</div>
        </div>
      </div>
      <div class="buttons-container">
        <button class="btn primary" onclick="toggleTerminal(true)"> H√íM TH∆Ø S·ªê 1 </button>
        <button class="btn" onclick="createSurprise()">C√ì G√å ƒê√ì ·ªû ƒê√ÇY?</button>
        <button class="btn" onclick="toggleBucket(true)">BUCKET LIST</button>
      </div>
    </div>
  </div>

  <script>
  // Prevent zoom on iOS
  document.addEventListener('gesturestart', function (e) {
    e.preventDefault();
  });

  // ========= Settings =========
  const settings = {
    particles: { 
      length: window.innerWidth < 768 ? 300 : 500, 
      duration: 2, 
      velocity: 100, 
      effect: -0.75, 
      size: window.innerWidth < 768 ? 20 : 30 
    }
  };

  // Adjust settings based on device performance
  const isLowPerformance = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) || 
                          window.innerWidth < 768 || 
                          window.devicePixelRatio > 2;
  
  if (isLowPerformance) {
    settings.particles.length = Math.min(200, settings.particles.length);
    settings.particles.size = Math.min(20, settings.particles.size);
  }

  // ========= Utilities =========
  class Point {
    constructor(x = 0, y = 0) { this.x = x; this.y = y; }
    clone() { return new Point(this.x, this.y); }
    length(len) { if (len === undefined) return Math.hypot(this.x, this.y); this.normalize(); this.x*=len; this.y*=len; return this; }
    normalize() { const l = this.length(); if (l) { this.x/=l; this.y/=l; } return this; }
  }

  class Particle {
    constructor(){ this.position=new Point(); this.velocity=new Point(); this.acceleration=new Point(); this.age=0; }
    initialize(x,y,dx,dy){ this.position.x=x; this.position.y=y; this.velocity.x=dx; this.velocity.y=dy; this.acceleration.x=dx*settings.particles.effect; this.acceleration.y=dy*settings.particles.effect; this.age=0; }
    update(dt){ this.position.x += this.velocity.x*dt; this.position.y += this.velocity.y*dt; this.velocity.x += this.acceleration.x*dt; this.velocity.y += this.acceleration.y*dt; this.age += dt; }
    draw(ctx,image){ const ease=t=>(--t)*t*t+1; const life=this.age/settings.particles.duration; const size=image.width*ease(life); ctx.globalAlpha=1-life; ctx.drawImage(image,this.position.x-size/2,this.position.y-size/2,size,size); }
  }

  class ParticlePool{
    constructor(length){ this.particles=new Array(length).fill(0).map(()=>new Particle()); this.firstActive=0; this.firstFree=0; this.duration=settings.particles.duration; }
    add(x,y,dx,dy){ this.particles[this.firstFree].initialize(x,y,dx,dy); this.firstFree=(this.firstFree+1)%this.particles.length; if(this.firstActive===this.firstFree) this.firstActive=(this.firstActive+1)%this.particles.length; }
    update(dt){
      if(this.firstActive<this.firstFree){ for(let i=this.firstActive;i<this.firstFree;i++) this.particles[i].update(dt); }
      else{ for(let i=this.firstActive;i<this.particles.length;i++) this.particles[i].update(dt); for(let i=0;i<this.firstFree;i++) this.particles[i].update(dt); }
      while(this.firstActive!==this.firstFree && this.particles[this.firstActive].age>=this.duration){ this.firstActive=(this.firstActive+1)%this.particles.length; }
    }
    draw(ctx,image){
      if(this.firstActive<this.firstFree){ for(let i=this.firstActive;i<this.firstFree;i++) this.particles[i].draw(ctx,image); }
      else{ for(let i=this.firstActive;i<this.particles.length;i++) this.particles[i].draw(ctx,image); for(let i=0;i<this.firstFree;i++) this.particles[i].draw(ctx,image); }
    }
  }

  // ========= Heart math =========
  function pointOnHeart(t){
    return new Point(
      160*Math.pow(Math.sin(t),3),
      130*Math.cos(t) - 50*Math.cos(2*t) - 20*Math.cos(3*t) - 10*Math.cos(4*t) + 25
    );
  }

  // Create particle sprite
  function createHeartSprite(size, color='#ea80b0'){
    const c=document.createElement('canvas'); c.width=c.height=size;
    const g=c.getContext('2d');
    const to=t=>{ const p=pointOnHeart(t); p.x=size/2 + p.x*size/350; p.y=size/2 - p.y*size/350; return p; };
    g.beginPath(); let t=-Math.PI; let p=to(t); g.moveTo(p.x,p.y);
    while(t<Math.PI){ t+=0.01; p=to(t); g.lineTo(p.x,p.y); }
    g.closePath();
    const grad=g.createRadialGradient(size/2,size/2,size*0.1,size/2,size/2,size*0.6);
    grad.addColorStop(0,color); grad.addColorStop(1,'#ff4d6d');
    g.fillStyle=grad; g.shadowColor=color; g.shadowBlur=20; g.fill();
    const img=new Image(); img.src=c.toDataURL(); return img;
  }

  (function boot(canvas){
    const ctx=canvas.getContext('2d');
    const pool=new ParticlePool(settings.particles.length);
    const rate=settings.particles.length/settings.particles.duration;
    const sprite=createHeartSprite(settings.particles.size,'#ea80b0');

    // DPR aware resize
    let dpr=1;
    function resize(){
      // Limit DPR on mobile for performance
      dpr = isLowPerformance ? 1 : Math.min(2, window.devicePixelRatio||1);
      const w=canvas.clientWidth, h=canvas.clientHeight;
      canvas.width=Math.floor(w*dpr); canvas.height=Math.floor(h*dpr);
      ctx.setTransform(1,0,0,1,0,0); ctx.scale(dpr,dpr);
    }
    window.addEventListener('resize', resize); resize();

    let time;
    let frameCount = 0;
    function render(){
      requestAnimationFrame(render);
      const now=performance.now()/1000;
      const dt=Math.min(0.033, now-(time||now));
      time=now;
      frameCount++;

      ctx.clearRect(0,0,canvas.width/dpr, canvas.height/dpr);

      // Reduce particle generation on low performance devices
      const amount = (isLowPerformance ? rate * 0.7 : rate) * dt;
      for(let i=0;i<amount;i++){
        const pos=pointOnHeart(Math.PI - 2*Math.PI*Math.random());
        const dir=pos.clone().length(settings.particles.velocity);
        pool.add(canvas.width/dpr/2 + pos.x, canvas.height/dpr/2 - pos.y, dir.x, -dir.y);
      }

      pool.update(dt);
      ctx.globalCompositeOperation='lighter';
      pool.draw(ctx,sprite);
      ctx.globalCompositeOperation='source-over';
    }
    render();

    // Touch and click events
    function addHearts() {
      const multiplier = isLowPerformance ? 0.5 : 1;
      const loops = Math.floor(5 * multiplier);
      const particles = Math.floor(80 * multiplier);
      
      for(let j=0;j<loops;j++){
        for(let i=0;i<particles;i++){
          const pos=pointOnHeart(Math.PI - 2*Math.PI*Math.random());
          const dir=pos.clone().length(settings.particles.velocity*0.5);
          pool.add(canvas.width/dpr/2 + pos.x, canvas.height/dpr/2 - pos.y, dir.x, -dir.y);
        }
      }
    }
    
    canvas.addEventListener('click', addHearts);
    canvas.addEventListener('touchstart', (e) => {
      e.preventDefault();
      addHearts();
    });

    // expose
    window.heartPool=pool; window.heartCanvas=canvas; window.heartDpr=()=>dpr;
  })(document.getElementById('pinkboard'));

  // Buttons
  function createHeartExplosion(){
    const pool=window.heartPool, canvas=window.heartCanvas, dpr=window.heartDpr();
    const multiplier = isLowPerformance ? 0.6 : 1;
    const loops = Math.floor(10 * multiplier);
    const particles = Math.floor(100 * multiplier);
    
    for(let j=0;j<loops;j++){
      for(let i=0;i<particles;i++){
        const pos=pointOnHeart(Math.PI - 2*Math.PI*Math.random());
        const dir=pos.clone().length(settings.particles.velocity*(0.3+Math.random()*0.7));
        pool.add(canvas.width/dpr/2 + pos.x, canvas.height/dpr/2 - pos.y, dir.x, -dir.y);
      }
    }
  }

  // Days counter
  const startDate=new Date('2025-07-20');
  const today=new Date();
  const diffTime=today - startDate;
  const diffDays=Math.floor(diffTime/(1000*60*60*24));
  document.getElementById('daysCount').textContent=diffDays;
  const daysInlineEl=document.getElementById('daysInline'); if(daysInlineEl) daysInlineEl.textContent=diffDays;

  // ===== Toggle Terminal =====
  const terminal = document.getElementById('terminal');
  const closeBtn = document.getElementById('closeTerminal');
  const backdrop = document.getElementById('backdrop');
  function toggleTerminal(open){
    if(open){
      terminal.classList.add('open');
      terminal.setAttribute('aria-hidden','false');
      backdrop.classList.add('open');
      createHeartExplosion();
      showTerminalLines(); // Hi·ªán t·ª´ng d√≤ng
    }else{
      terminal.classList.remove('open');
      terminal.setAttribute('aria-hidden','true');
      // ch·ªâ ƒë√≥ng backdrop n·∫øu bucket c≈©ng ƒë√≥ng
      if(!bucketPanel.classList.contains('open')) backdrop.classList.remove('open');
    }
  }
  closeBtn.addEventListener('click', ()=>toggleTerminal(false));
  window.addEventListener('keydown', (e)=>{ if(e.key==='Escape') toggleTerminal(false); });
  backdrop.addEventListener('click', ()=>{
    if(terminal.classList.contains('open')) toggleTerminal(false);
    if(bucketPanel.classList.contains('open')) toggleBucket(false);
  });
  
  // Touch events for mobile
  let touchStartY = 0;
  backdrop.addEventListener('touchstart', (e) => {
    touchStartY = e.touches[0].clientY;
  });
  backdrop.addEventListener('touchend', (e) => {
    const touchEndY = e.changedTouches[0].clientY;
    const diff = Math.abs(touchEndY - touchStartY);
    if (diff < 10) { // Only close if it's a tap, not a scroll
      if(terminal.classList.contains('open')) toggleTerminal(false);
      if(bucketPanel.classList.contains('open')) toggleBucket(false);
    }
  });

  function showTerminalLines() {
    const lines = document.querySelectorAll('#terminalBody .line');
    lines.forEach(line => line.style.display = 'none');
    let i = 0;
    function showNext() {
      if (i < lines.length) {
        lines[i].style.display = 'block';
        i++;
        setTimeout(showNext, isLowPerformance ? 500 : 700);
      }
    }
    showNext();
  }

  // ===== Bucket List logic =====
  const bucketPanel = document.getElementById('bucketPanel');
  const bucketClose = document.getElementById('closeBucket');
  const blList = document.getElementById('blList');
  const blForm = document.getElementById('blForm');
  const blTitle = document.getElementById('blTitle');
  const blWhen = document.getElementById('blWhen');
  const blDoneEl = document.getElementById('blDone');
  const blTotalEl = document.getElementById('blTotal');
  const blBar = document.getElementById('blBar');

  let blFilter = 'all'; // all | todo | done
  let bucketData = loadBucket();

  function toggleBucket(open){
    if(open){
      bucketPanel.classList.add('open');
      bucketPanel.setAttribute('aria-hidden','false');
      backdrop.classList.add('open'); // t√°i d√πng backdrop
      renderBucket();
    }else{
      bucketPanel.classList.remove('open');
      bucketPanel.setAttribute('aria-hidden','true');
      // ch·ªâ ƒë√≥ng backdrop n·∫øu terminal c≈©ng ƒë√≥ng
      if(!terminal.classList.contains('open')) backdrop.classList.remove('open');
    }
  }
  bucketClose.addEventListener('click', ()=>toggleBucket(false));
  window.addEventListener('keydown', (e)=>{ if(e.key==='Escape') toggleBucket(false); });

  // LocalStorage
  function loadBucket(){
    try{ return JSON.parse(localStorage.getItem('bucketList')||'[]'); }
    catch{ return []; }
  }
  function saveBucket(){ localStorage.setItem('bucketList', JSON.stringify(bucketData)); }

  // CRUD
  function addItem(title, when){
    const id = Date.now().toString(36);
    bucketData.push({ id, title: title.trim(), when: when||'', done: false });
    saveBucket(); renderBucket();
  }
  function toggleItem(id){
    bucketData = bucketData.map(it => it.id===id ? {...it, done: !it.done} : it);
    saveBucket(); renderBucket();
  }
  function deleteItem(id){
    bucketData = bucketData.filter(it => it.id!==id);
    saveBucket(); renderBucket();
  }

  // Render
  function renderBucket(){
    // filter
    const items = bucketData.filter(function(it){
      if(blFilter==='todo') return !it.done;
      if(blFilter==='done') return it.done;
      return true;
    });

    // list HTML
    blList.innerHTML = items.map(function(it){
      var whenText = it.when ? 'M·ª•c ti√™u: ' + formatDate(it.when) : '';
      var html = '<li class="bl-item ' + (it.done ? 'done':'') + '">' +
        '<input class="bl-item__check" type="checkbox" ' + (it.done?'checked':'') + ' aria-label="Ho√†n th√†nh" onclick="toggleItem(\'' + it.id + '\')">' +
        '<div>' +
          '<div class="bl-item__title">' + escapeHtml(it.title) + '</div>' +
          (whenText ? '<div class="bl-item__meta">' + whenText + '</div>' : '') +
        '</div>' +
        '<button class="bl-item__del" onclick="deleteItem(\'' + it.id + '\')">X√≥a</button>' +
      '</li>';
      return html;
    }).join('');

    // progress
    var total = bucketData.length;
    var done = bucketData.filter(function(it){return it.done;}).length;
    blTotalEl.textContent = total;
    blDoneEl.textContent = done;
    var pct = total ? Math.round((done/total)*100) : 0;
    blBar.style.width = pct + '%';
    blBar.setAttribute('aria-valuenow', String(pct));
  }

  // Form submit
  blForm.addEventListener('submit', (e)=>{
    e.preventDefault();
    if(!blTitle.value.trim()) return;
    addItem(blTitle.value, blWhen.value);
    blForm.reset();
    blTitle.focus();
  });

  // Filters
  document.querySelectorAll('.bl-filters .btn').forEach(btn=>{
    btn.addEventListener('click', ()=>{
      blFilter = btn.getAttribute('data-filter');
      renderBucket();
    });
  });

  // Utils
  function formatDate(v){
    // v: yyyy-mm-dd -> dd/mm/yyyy
    var parts = v.split('-');
    return parts[2] + '/' + parts[1] + '/' + parts[0];
  }
  function escapeHtml(str){
    return str.replace(/[&<>"']/g, function(m){
      return {
        '&':'&amp;',
        '<':'&lt;',
        '>':'&gt;',
        '"':'&quot;',
        "'":'&#39;'
      }[m];
    });
  }

  // Expose for inline onclick
  window.toggleBucket = toggleBucket;
  window.toggleItem = toggleItem;
  window.deleteItem = deleteItem;

  // ƒê·∫£m b·∫£o c√°c h√†m n√∫t ƒë·ªÅu g√°n v√†o window ƒë·ªÉ onclick ho·∫°t ƒë·ªông
  window.toggleTerminal = toggleTerminal;
  window.createSurprise = createSurprise;
  window.toggleBucket = toggleBucket;

  // (Tu·ª≥ ch·ªçn) Seed v√≠ d·ª• l·∫ßn ƒë·∫ßu:
  if(bucketData.length === 0){
    bucketData = [
      {id:'ex1', title:'Leo Fansipan', when:'2026-06-01', done:false},
      {id:'ex2', title:'H·ªçc l·∫∑n bi·ªÉn', when:'', done:false},
      {id:'ex3', title:'Vi·∫øt ebook 50 trang', when:'2025-12-31', done:true},
    ];
    saveBucket();
  }

  // Hi·ªáu ·ª©ng b·∫•t ng·ªù cho n√∫t "C√≥ g√¨ ƒë√≥ ·ªü ƒë√¢y?"
  function createSurprise() {
    var surpriseText = document.getElementById('surpriseText');
    var lines = surpriseText.querySelectorAll('.surprise-line');
    surpriseText.style.display = 'block';
    // ·∫®n t·∫•t c·∫£ d√≤ng tr∆∞·ªõc
    lines.forEach(function(line) { line.style.display = 'none'; });
    // Hi·ªán t·ª´ng d√≤ng v·ªõi hi·ªáu ·ª©ng typewriter
    var i = 0;
    function showNextLine() {
      if (i < lines.length) {
        lines[i].style.display = 'block';
        createHeartExplosion(); // hi·ªáu ·ª©ng tr√°i tim n·ªï m·ªói d√≤ng
        i++;
        setTimeout(showNextLine, 900);
      }
    }
    showNextLine();
  }
  </script>
</body>
</html>
